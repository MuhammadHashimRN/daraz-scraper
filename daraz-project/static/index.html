<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daraz Scraper Pro Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease;
        }
        .header h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .connected { background: #10b981; color: white; }
        .disconnected { background: #ef4444; color: white; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            animation: fadeInUp 0.6s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .btn {
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .status-grid { display: grid; gap: 12px; }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .log-info { color: #4facfe; }
        .log-success { color: #38ef7d; }
        .log-error { color: #f5576c; }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input, .search-box select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .filter-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .filter-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .product-card:hover { transform: translateY(-5px); }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .product-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .product-price {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .product-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
        }
        .plots-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .plot-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .plot-card h3 { color: #333; margin-bottom: 15px; }
        .plot-card img, .plot-card iframe {
            width: 100%;
            border-radius: 12px;
            cursor: pointer;
        }
        .plot-card iframe {
            height: 500px;
            border: none;
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        .stat-box .number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-box .label { font-size: 0.9em; opacity: 0.9; }
        .price-changes {
            max-height: 300px;
            overflow-y: auto;
        }
        .price-change-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .price-up { border-left-color: #ef4444; }
        .price-down { border-left-color: #10b981; }
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.4s ease;
        }
        .toast.show { display: block; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
        }
        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
        }
        .modal-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ‚ö†Ô∏è Disconnected
    </div>

    <div class="container">
        <div class="header">
            <h1>üõí Daraz Scraper Pro</h1>
            <p>Real-time laptop data scraping, clustering & analysis platform</p>
        </div>

        <div class="grid">
            <!-- Control Panel -->
            <div class="card">
                <h2><span>üéÆ</span>Control Panel</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startScraping()" id="scrapeBtn">
                        üì• Scrape Data
                    </button>
                    <button class="btn btn-success" onclick="processData()" id="processBtn">
                        üîÑ Process
                    </button>
                    <button class="btn btn-warning" onclick="runAll()" id="allBtn">
                        üöÄ Run All
                    </button>
                    <button class="btn btn-info" onclick="checkStatus()">
                        üîç Refresh
                    </button>
                    <button class="btn btn-info" onclick="downloadCSV()">
                        üìä Download CSV
                    </button>
                    <button class="btn btn-danger" onclick="cleanFiles()">
                        üóëÔ∏è Clean Files
                    </button>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <h2><span>üìä</span>System Status</h2>
                <div class="status-grid" id="statusGrid">
                    <div class="status-item"><span>Loading...</span></div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2><span>üìà</span>Live Statistics</h2>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="number" id="productCount">-</div>
                        <div class="label">Products</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="plotCount">-</div>
                        <div class="label">Visualizations</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="clusterCount">-</div>
                        <div class="label">Clusters</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="requestCount">-</div>
                        <div class="label">API Requests</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <h2><span>üìù</span>Real-time Activity Log</h2>
            <div class="log-viewer" id="activityLog">
                <div class="log-entry log-info">Waiting for activity...</div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="card" style="margin-top: 20px;">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">üîç Search</button>
                <button class="tab" onclick="switchTab('plots')">üìä Visualizations</button>
                <button class="tab" onclick="switchTab('prices')">üí∞ Price Tracking</button>
                <button class="tab" onclick="switchTab('clusters')">üéØ Clusters</button>
            </div>

            <!-- Search Tab -->
            <div id="searchTab" class="tab-content active">
                <h2><span>üîç</span>Advanced Product Search</h2>
                <div class="search-box">
                    <input type="text" id="searchQuery" placeholder="Search products..." onkeyup="searchProducts()">
                    <div class="filter-group">
                        <input type="number" id="minPrice" placeholder="Min Price" onchange="searchProducts()">
                        <input type="number" id="maxPrice" placeholder="Max Price" onchange="searchProducts()">
                        <input type="number" id="minRating" placeholder="Min Rating (0-5)" step="0.1" onchange="searchProducts()">
                        <input type="text" id="brandFilter" placeholder="Brand" onchange="searchProducts()">
                        <input type="number" id="minRAM" placeholder="Min RAM (GB)" onchange="searchProducts()">
                        <input type="number" id="minStorage" placeholder="Min Storage (GB)" onchange="searchProducts()">
                    </div>
                </div>
                <div class="products-grid" id="productsGrid">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Use search and filters above to find products
                    </p>
                </div>
            </div>

            <!-- Plots Tab -->
            <div id="plotsTab" class="tab-content">
                <h2><span>üìä</span>Interactive Visualizations</h2>
                <div class="plots-gallery" id="plotsGallery">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        No visualizations available. Run the pipeline to generate plots.
                    </p>
                </div>
            </div>

            <!-- Price Tracking Tab -->
            <div id="pricesTab" class="tab-content">
                <h2><span>üí∞</span>Price Changes Over Time</h2>
                <div class="price-changes" id="priceChanges">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        No price history available yet.
                    </p>
                </div>
            </div>

            <!-- Clusters Tab -->
            <div id="clustersTab" class="tab-content">
                <h2><span>üéØ</span>Cluster Analysis</h2>
                <div id="clustersInfo">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        No cluster data available. Run processing first.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div id="toastMessage"></div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <img id="modalImage" src="" alt="Full size">
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let socket;
        let activityLogs = [];

        // Initialize WebSocket connection
        function initWebSocket() {
            socket = io(API_URL);

            socket.on('connect', () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                socket.emit('request_status');
            });

            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
            });

            socket.on('status_update', (data) => {
                updateStatus(data);
            });

            socket.on('log', (data) => {
                addLog(data.message, data.type);
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.textContent = '‚úì Connected';
            } else {
                status.className = 'connection-status disconnected';
                status.textContent = '‚ö†Ô∏è Disconnected';
            }
        }

        function updateStatus(data) {
            // Update status grid
            const statusGrid = document.getElementById('statusGrid');
            const files = data.files;
            const processes = data.processes;
            
            statusGrid.innerHTML = `
                <div class="status-item">
                    <span>Raw CSV</span>
                    <span class="status-badge ${files.raw_csv_exists ? 'badge-success' : 'badge-danger'}">
                        ${files.raw_csv_exists ? '‚úì Exists' : '‚úó Missing'}
                    </span>
                </div>
                <div class="status-item">
                    <span>Processed CSV</span>
                    <span class="status-badge ${files.processed_csv_exists ? 'badge-success' : 'badge-danger'}">
                        ${files.processed_csv_exists ? '‚úì Exists' : '‚úó Missing'}
                    </span>
                </div>
                <div class="status-item">
                    <span>Scraping</span>
                    <span class="status-badge ${processes.scraping ? 'badge-warning' : 'badge-info'}">
                        ${processes.scraping ? '‚è≥ Running' : '‚úì Idle'}
                    </span>
                </div>
                <div class="status-item">
                    <span>Processing</span>
                    <span class="status-badge ${processes.processing ? 'badge-warning' : 'badge-info'}">
                        ${processes.processing ? '‚è≥ Running' : '‚úì Idle'}
                    </span>
                </div>
            `;

            // Update button states
            document.getElementById('scrapeBtn').disabled = processes.scraping;
            document.getElementById('processBtn').disabled = processes.processing;
            document.getElementById('allBtn').disabled = processes.scraping || processes.processing;

            // Update stats
            const plotCount = Object.keys(files.plots_exist || {}).length;
            document.getElementById('plotCount').textContent = plotCount;

            if (data.metrics) {
                document.getElementById('requestCount').textContent = data.metrics.requests || 0;
            }

            // Auto-load content if available
            if (plotCount > 0) {
                loadPlots();
            }
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logClass = `log-${type}`;
            const logEntry = `<div class="log-entry ${logClass}">[${timestamp}] ${message}</div>`;
            
            const logViewer = document.getElementById('activityLog');
            logViewer.innerHTML = logEntry + logViewer.innerHTML;
            
            // Keep only last 50 entries
            const entries = logViewer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[entries.length - 1].remove();
            }
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                updateStatus(data);
                addLog('‚úÖ Status refreshed', 'success');
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function startScraping() {
            try {
                addLog('üì• Starting scraping...', 'info');
                const response = await fetch(`${API_URL}/scrape`);
                const data = await response.json();
                showToast(data.status || data.error);
            } catch (error) {
                addLog(`‚ùå Scraping failed: ${error.message}`, 'error');
                showToast('Scraping failed!');
            }
        }

        async function processData() {
            try {
                addLog('üîÑ Starting processing...', 'info');
                const response = await fetch(`${API_URL}/process`);
                const data = await response.json();
                showToast(data.status || data.error);
            } catch (error) {
                addLog(`‚ùå Processing failed: ${error.message}`, 'error');
                showToast('Processing failed!');
            }
        }

        async function runAll() {
            try {
                addLog('üöÄ Starting full pipeline...', 'info');
                showToast('Running full pipeline (this may take several minutes)...', 5000);
                const response = await fetch(`${API_URL}/all`);
                const data = await response.json();
                showToast(data.status || data.error);
            } catch (error) {
                addLog(`‚ùå Pipeline failed: ${error.message}`, 'error');
                showToast('Pipeline failed!');
            }
        }

        async function downloadCSV() {
            try {
                window.open(`${API_URL}/csv`, '_blank');
                addLog('üìä CSV download started', 'info');
            } catch (error) {
                addLog(`‚ùå Download failed: ${error.message}`, 'error');
            }
        }

        async function cleanFiles() {
            if (!confirm('Delete all generated files?')) return;
            
            try {
                const response = await fetch(`${API_URL}/clean`);
                const data = await response.json();
                addLog(`üóëÔ∏è Cleaned ${data.count} files`, 'success');
                showToast('Files cleaned successfully');
                checkStatus();
            } catch (error) {
                addLog(`‚ùå Clean failed: ${error.message}`, 'error');
            }
        }

        async function searchProducts() {
            const query = document.getElementById('searchQuery').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || 999999;
            const minRating = parseFloat(document.getElementById('minRating').value) || 0;
            const brand = document.getElementById('brandFilter').value;
            const minRAM = parseFloat(document.getElementById('minRAM').value) || 0;
            const minStorage = parseFloat(document.getElementById('minStorage').value) || 0;

            try {
                const response = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query, min_price: minPrice, max_price: maxPrice,
                        min_rating: minRating, brand, min_ram: minRAM, min_storage: minStorage
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('productsGrid').innerHTML = 
                        `<p style="text-align: center; color: #ef4444; padding: 40px;">${data.error}</p>`;
                    return;
                }

                displayProducts(data.products);
                document.getElementById('productCount').textContent = data.total;
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No products found</p>';
                return;
            }

            grid.innerHTML = products.map(product => `
                <div class="product-card">
                    ${product.local_image ? 
                        `<img src="${API_URL}${product.local_image}" class="product-image" alt="${product.title}" onerror="this.src='https://via.placeholder.com/280x200?text=No+Image'">` :
                        `<img src="https://via.placeholder.com/280x200?text=No+Image" class="product-image">`
                    }
                    <div class="product-title">${product.title || 'N/A'}</div>
                    <div class="product-price">${product.price ? product.price.toFixed(2) : 'N/A'}</div>
                    <div class="product-meta">
                        <span>‚≠ê ${product.rating || 0}</span>
                        <span>${product.brand || 'Unknown'}</span>
                    </div>
                    <div class="product-meta">
                        <span>RAM: ${product.ram_gb || 0}GB</span>
                        <span>Storage: ${product.storage_gb || 0}GB</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadPlots() {
            const gallery = document.getElementById('plotsGallery');
            const plots = [
                { name: 'pca_interactive', title: 'Interactive PCA Analysis', type: 'html' },
                { name: 'umap_3d', title: '3D UMAP Visualization', type: 'html' },
                { name: 'cluster_analysis', title: 'Cluster Analysis Dashboard', type: 'html' },
                { name: 'price_distribution', title: 'Price Distribution by Cluster', type: 'html' },
                { name: 'pca_combined', title: 'PCA with Clustering', type: 'png' },
                { name: 'umap_heatmap_price', title: 'UMAP - Price Heatmap', type: 'png' },
                { name: 'umap_composite', title: 'UMAP - Composite Score', type: 'png' }
            ];

            gallery.innerHTML = '';

            for (const plot of plots) {
                try {
                    const response = await fetch(`${API_URL}/plot/${plot.name}`);
                    if (response.ok) {
                        const plotCard = document.createElement('div');
                        plotCard.className = 'plot-card';
                        
                        if (plot.type === 'html') {
                            plotCard.innerHTML = `
                                <h3>${plot.title}</h3>
                                <iframe src="${API_URL}/plot/${plot.name}"></iframe>
                            `;
                        } else {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            plotCard.innerHTML = `
                                <h3>${plot.title}</h3>
                                <img src="${url}" alt="${plot.title}" onclick="openModal('${url}')">
                            `;
                        }
                        
                        gallery.appendChild(plotCard);
                    }
                } catch (error) {
                    console.error(`Failed to load ${plot.name}:`, error);
                }
            }
        }

        async function loadPriceChanges() {
            try {
                const response = await fetch(`${API_URL}/price-changes`);
                const data = await response.json();
                
                const container = document.getElementById('priceChanges');
                
                if (data.error || !data.all_changes || data.all_changes.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No price changes detected yet</p>';
                    return;
                }

                container.innerHTML = data.all_changes.map(change => `
                    <div class="price-change-item ${change.change > 0 ? 'price-up' : 'price-down'}">
                        <div style="font-weight: 600; margin-bottom: 5px;">${change.title}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${change.old_price.toFixed(2)} ‚Üí ${change.new_price.toFixed(2)}</span>
                            <span style="font-weight: bold; color: ${change.change > 0 ? '#ef4444' : '#10b981'}">
                                ${change.change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change.change_percent).toFixed(1)}%
                            </span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load price changes:', error);
            }
        }

        async function loadClusters() {
            try {
                const response = await fetch(`${API_URL}/clusters`);
                const data = await response.json();
                
                const container = document.getElementById('clustersInfo');
                
                if (data.error) {
                    container.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">${data.error}</p>`;
                    return;
                }

                document.getElementById('clusterCount').textContent = data.total_clusters;

                container.innerHTML = `
                    <div class="stats-row">
                        ${data.clusters.map(cluster => `
                            <div class="stat-box">
                                <div class="number">Cluster ${cluster.cluster_id}</div>
                                <div class="label">${cluster.size} products</div>
                                <div style="margin-top: 10px; font-size: 0.9em;">
                                    <div>Avg Price: ${cluster.avg_price.toFixed(2)}</div>
                                    <div>Avg RAM: ${cluster.avg_ram.toFixed(1)}GB</div>
                                    <div>Avg Storage: ${cluster.avg_storage.toFixed(1)}GB</div>
                                    <div>Avg Rating: ${cluster.avg_rating.toFixed(2)}‚≠ê</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load clusters:', error);
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'plots') loadPlots();
            if (tabName === 'prices') loadPriceChanges();
            if (tabName === 'clusters') loadClusters();
        }

        function openModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('show');
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initWebSocket();
            checkStatus();
            addLog('üöÄ Dashboard initialized', 'info');
        });
    </script>
</body>
</html>